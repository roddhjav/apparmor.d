# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2024 valoq <valoq@mailbox.org>
# SPDX-License-Identifier: GPL-2.0-only

abi <abi/3.0>,

include <tunables/global>

@{exec_path} = @{lib}/libreoffice/program/soffice.bin
profile libreoffice-soffice @{exec_path} {
  include <abstractions/base>
  include <abstractions/dconf-write>
  include <abstractions/desktop>
  include <abstractions/fontconfig-cache-read>
  include <abstractions/graphics>
  include <abstractions/nameservice-strict>
  include <abstractions/user-write-strict>

  @{exec_path} mr,
  @{bin}/paperconf rix,

  @{sh_path} rix,

  @{lib}/libreoffice/{,**} r,
  @{lib}/gconv/gconv-modules.cache r,
  # aa-log requested, but should not be user writeable
  owner @{lib}/libreoffice/share/uno_packages/cache/stamp.sys w,
  
  /usr/share/libreoffice/{,**} r,
  /usr/share/libexttextcat/{,**} r,
  /usr/share/liblangtag/{,**} r,
  /usr/share/ca-certificates/trust-source/{,**} r,
  /usr/share/hunspell/{,**} r, 
  /usr/share/hyphen/{,**} r,
  /usr/share/mythes/{,**} r,
 
  /etc/libreoffice/{,**} r,
  /etc/java@{int}-openjdk/{,**} r,
  /etc/paperspecs r,
  /etc/machine-id r,
  /etc/ca-certificates/trust-source/{,**} r,

  owner /var/spool/libreoffice/{,**} rw, 
  owner @{user_cache_dirs}/libreoffice/{,**} rw,
  owner @{user_config_dirs}/libreoffice/{,**} rwk,

  /tmp/ r,
  owner @{tmp}/@{rand6} rwk,
  owner @{tmp}/*.tmp/{,**} rwk,
  owner @{tmp}/OSL_PIPE_@{uid}_SingleOfficeIPC_@{hex} w,
  owner @{tmp}/.java_pid@{int}{,.tmp} rw,
  owner @{tmp}/hsperfdata_@{user}/  rw,
  owner @{tmp}/hsperfdata_@{user}/@{int} rwk,

  # /dev/tty rw,

  owner /dev/pts/@{int} r,

        @{sys}/devices/system/cpu/cpu@{int}/microcode/version r,
        @{sys}/devices/virtual/block/**/queue/rotational r,
        @{sys}/kernel/mm/hugepages/ r,
        @{sys}/kernel/mm/transparent_hugepage/enabled r,
        @{sys}/kernel/mm/transparent_hugepage/shmem_enabled r,
  owner @{sys}/fs/cgroup/user.slice/user-@{int}.slice/user@@{int}.service/app.slice/**/memory.max r,

  @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/session-@{int}.scope/cpu.max r,
  @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/session-@{int}.scope/memory.max r,

        @{PROC}/cgroups r,
  owner @{PROC}/@{pid}/cgroup r,
  owner @{PROC}/@{pid}/coredump_filter rw,
  owner @{PROC}/@{pid}/mountinfo r,

  profile paperconf {
    @{bin}/paperconf r,
  
    @{lib}/libreoffice/program/types.rdb r,  # file_inherit
    @{lib}/libreoffice/program/types/offapi.rdb r,  # file_inherit
    @{lib}/libreoffice/program/types/oovbaapi.rdb r,  # file_inherit
    @{lib}/libreoffice/share/config/images_elementary.zip r,  # file_inherit
  
    /etc/paperspecs r,
  
    owner @{user_config_dirs}/libreoffice/4/user/extensions/bundled/extensions.pmap rw,  # file_inherit
  }


  include if exists <local/libreoffice>
}
