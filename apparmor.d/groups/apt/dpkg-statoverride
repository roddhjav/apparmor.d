# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2025 Alexandre Pujol <alexandre@pujol.io>
# SPDX-License-Identifier: GPL-2.0-only

abi <abi/4.0>,

include <tunables/global>

@{exec_path} = @{bin}/dpkg-statoverride
profile dpkg-statoverride @{exec_path} flags=(complain) {
  include <abstractions/base>
  include <abstractions/consoles>
  include <abstractions/libvirt-qemu>
  include <abstractions/nameservice-strict>
  include <abstractions/mapping/login>

  @{exec_path} mr,

  @{etc_ro}/mpd.conf w,
  /var/lib/geoclue/ w,
  /var/lib/dpkg/statoverride r,
  /var/lib/ice/ w,
  /var/lib/mpd/ w,
  /var/lib/mpd/playlists/ w,
  owner /var/lib/dpkg/ r,
  owner /var/lib/dpkg/statoverride{,-*} rwl,
  owner /var/lib/softhsm/ w,
  owner /var/lib/softhsm/tokens/ w,

  owner /{usr/,}lib{,32,64}/** rw,

  owner @{bin}/crontab w,
  owner @{bin}/plocate w,
  owner @{sbin}/postdrop w,
  owner @{sbin}/postqueue w,

  owner @{etc_rw}/exim4/passwd.client w,
  owner @{etc_rw}/softhsm/ w,
  owner @{etc_rw}/softhsm/softhsm2.conf w,
  owner @{etc_rw}/ssl/private/ w,

  /var/log/mpd/ w,
  include if exists <local/dpkg-statoverride>
}

# vim:syntax=apparmor
