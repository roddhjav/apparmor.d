# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2021-2024 Alexandre Pujol <alexandre@pujol.io>
# SPDX-License-Identifier: GPL-2.0-only

abi <abi/4.0>,

include <tunables/global>

@{exec_path} = @{bin}/pacman
profile pacman @{exec_path} flags=(attach_disconnected) {
  include <abstractions/base>
  include <abstractions/consoles>
  include <abstractions/disks-read>
  include <abstractions/nameservice-strict>
  include <abstractions/ssl_certs>

  capability audit_write,
  capability chown,
  capability dac_override,
  capability dac_read_search,
  capability fowner,
  capability fsetid,
  capability kill,
  capability mknod,
  capability net_admin,
  capability setfcap,
  capability setgid,
  capability setuid,
  capability sys_admin,
  capability sys_chroot,
  capability sys_ptrace,
  capability sys_resource,

  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,
  network netlink raw,
  network unix stream,

  ptrace read,

  signal send,
  signal receive set=(term winch) peer=makepkg//sudo,

  @{exec_path} mrix,

  # Pacman's keyring
  @{bin}/gpg{,2}                                  Cx -> gpg,
  @{bin}/gpgconf                                  Cx -> gpg,
  @{bin}/gpgsm                                    Cx -> gpg,

  # Common program found in hooks & install scripts
  @{sh_path}                                     rix,
  @{coreutils_path}                              rix,
  @{bin}/dot                                      ix,
  @{bin}/filecap                                  ix,
  @{bin}/getent                                   ix,
  @{bin}/gettext                                  ix,
  @{bin}/gzip                                     ix,
  @{bin}/rsync                                    ix,
  @{bin}/setfacl                                  ix,
  @{bin}/tput                                     ix,
  @{bin}/vercmp                                   ix,
  @{bin}/which{,.debianutils}                     ix,
  @{bin}/xmlcatalog                               ix,
  @{sbin}/iconvconfig                             ix,
  @{sbin}/iscsi-iname                             ix,
  @{sbin}/setcap                                  ix,

  @{bin}/dbus-send                                Cx -> bus,
  @{bin}/gdbus                                    Cx -> bus,
  @{bin}/killall                                  Cx -> pkill,
  @{bin}/kmod                                     Cx -> kmod,
  @{bin}/pkill                                    Cx -> pkill,
  @{bin}/systemctl                                Cx -> systemctl,
  @{sbin}/ldconfig                                Cx -> ldconfig,

  #aa:lint ignore=too-wide
  # Hooks & install scripts can legitimately start/restart anything
  # PU is only used as a safety fallback.
  @{bin}/**                                       PUx,
  @{sbin}/**                                      PUx,
  /opt/*/**                                       PUx,
  /etc/**                                         PUx,
  /usr/share/**                                   PUx,

  priority=-1 @{lib}/**                          PUx,
  @{lib}/ghc-@{version}/bin/ghc-pkg-@{version}    Px,
  @{lib}/systemd/systemd-*                        Px,
  @{lib}/vlc/vlc-cache-gen                        Px,

  # For shell pwd, keept as it can annoy users to see error in pacman output
  /**/ r,

  # Install/update packages
  #aa:lint ignore=too-wide
  / r,
  /*{,/} rw,
  @{efi}/** rwl -> @{efi}/**,
  /etc/** rwl -> /etc/**,
  /opt/** rwl -> /opt/**,
  /srv/** rwl -> /srv/**,
  /usr/** rwlk -> /usr/**,
  /var/** rwlk -> /var/**,

  # Read packages files
  @{user_pkg_dirs}/{,**} r,

  owner /var/lib/pacman/{,**} rwl,
  owner @{tmp}/alpm_@{rand6}/{,**} rw,
  owner @{tmp}/arch-update-@{uid}/checkupdates-@{rand}/sync/** w,
  owner @{tmp}/checkup-db-@{int}/db.lck rw,
  owner @{tmp}/checkup-db-@{int}/sync/{,*.db*} rw,

  @{run}/utmp rk,

  @{sys}/{,**} r,

        @{PROC}/@{pids}/ r,
        @{PROC}/@{pids}/cgroup r,
        @{PROC}/@{pids}/cmdline r,
        @{PROC}/@{pids}/environ r,
        @{PROC}/@{pids}/stat r,
        @{PROC}/sys/kernel/osrelease r,
        @{PROC}/tty/drivers r,
        @{PROC}/uptime r,
  owner @{PROC}/@{pid}/fd/ r,
  owner @{PROC}/@{pid}/mounts r,

        /dev/tty@{u8} rw,
  owner /dev/pts/@{u16} rw,

  profile gpg {
    include <abstractions/base>
    include <abstractions/nameservice-strict>
    include <abstractions/ssl_certs>

    capability dac_read_search,

    network inet stream,
    network inet6 stream,
    network inet dgram,
    network inet6 dgram,

    @{bin}/gpg{,2} mr,
    @{bin}/gpgconf mr,
    @{bin}/gpgsm   mr,

    @{bin}/dirmngr           rix,
    @{bin}/gpg-agent         rix,
    @{bin}/gpg-connect-agent rix,

    /etc/pacman.d/gnupg/ rw,
    /etc/pacman.d/gnupg/** rwkl -> /etc/pacman.d/gnupg/**,

    @{HOME}/@{XDG_GPG_DIR}/*.conf r,

    @{PROC}/@{pid}/fd/ r,
    @{PROC}/@{pid}/task/@{tid}/comm rw,

          /dev/tty@{u8} rw,
    owner /dev/pts/@{u16} rw,

    deny @{user_share_dirs}/sddm/* rw,

    include if exists <local/pacman_gpg>
  }

  profile systemctl flags=(attach_disconnected) {
    include <abstractions/base>
    include <abstractions/app/systemctl>
    include <abstractions/nameservice-strict>

    capability net_admin,
    capability dac_read_search,
    capability sys_resource,

    ptrace read peer=@{p_systemd},

    signal send set=cont peer=child-pager,
    signal send set=(cont term) peer=systemd-tty-ask-password-agent,
    signal receive set=(term winch) peer=makepkg//sudo,

    unix (send receive) type=stream peer=(label=pacman),

    @{pager_path}      rPx -> child-pager,
    @{bin}/systemd-tty-ask-password-agent rPx,

    /etc/machine-id r,

    /{run,var}/log/journal/ r,
    /{run,var}/log/journal/@{hex32}/ r,
    /{run,var}/log/journal/@{hex32}/system.journal* r,
    /{run,var}/log/journal/@{hex32}/system@@{hex}-@{hex}.journal* r,
    /{run,var}/log/journal/@{hex32}/system@@{hex32}-@{hex16}-@{hex16}.journal* r,
    /{run,var}/log/journal/@{hex32}/user-@{hex}.journal* r,
    /{run,var}/log/journal/@{hex32}/user-@{uid}@@{hex}-@{hex}.journal* r,
    /{run,var}/log/journal/@{hex32}/user-@{uid}@@{hex32}-@{hex16}-@{hex16}.journal* r,

    include if exists <local/pacman_systemctl>
  }

  profile bus {
    include <abstractions/base>
    include <abstractions/app/bus>
    include <abstractions/bus-system>
    include <abstractions/bus/system/org.freedesktop.PackageKit>

    unix (send receive) type=stream peer=(label=pacman),

    @{bin}/gdbus rix,

    include if exists <local/pacman_bus>
  }

  profile pkill {
    include <abstractions/base>
    include <abstractions/app/pgrep>

    capability dac_read_search,
    capability kill,

    signal send,

    unix (send receive) type=stream peer=(label=pacman),

    @{bin}/killall mr,
    @{bin}/pkill mr,

    include if exists <local/pacman_pkill>
  }

  profile kmod {
    include <abstractions/base>
    include <abstractions/app/kmod>

    include if exists <local/pacman_kmod>
  }

  profile ldconfig {
    include <abstractions/base>
    include <abstractions/consoles>

    capability sys_chroot,

    unix (send receive) type=stream peer=(label=pacman),

    @{sh_path}              rix,
    @{sbin}/ldconfig       mrix,

    @{lib}/ r,
    /usr/local/ r,
    /usr/local/lib/ r,

    /opt/cuda/**/@{lib}/ r,
    /opt/cuda/**/@{lib}/@{multiarch}/ r,
    /opt/cuda/**/@{lib}/**.so* r,

    /etc/ld.so.cache rw,
    /etc/ld.so.cache~ rw,

          /var/cache/ldconfig/ rw,
    owner /var/cache/ldconfig/aux-cache* rw,

    include if exists <local/pacman_ldconfig>
  }

  include if exists <usr/pacman.d>
  include if exists <local/pacman>
}

# vim:syntax=apparmor
