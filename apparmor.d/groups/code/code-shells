# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2025 Alexandre Pujol <alexandre@pujol.io>
# SPDX-License-Identifier: GPL-2.0-only

abi <abi/4.0>,

include <tunables/global>

@{devtools} += rust-analyzer harper-ls proc-macro-srv

@{name} = code{,-oss} vscode{,-oss}
@{config} = Code Code?-?OSS Code?-?Insiders
@{config_dirs} = @{HOME}/.@{name} @{user_config_dirs}/@{config}
@{ext_dirs} = @{config_dirs}/extensions
@{lib_dirs} = @{ext_dirs}/

profile code-shells flags=(attach_disconnected) {
  include <abstractions/base>
  include <abstractions/app/code-extension>
  include <abstractions/bus-system>
  include <abstractions/consoles>
  include <abstractions/development>
  include <abstractions/gtk-strict>
  include <abstractions/nameservice-strict>
  include <abstractions/shells>
  include <abstractions/ssl_certs>
  include <abstractions/wutmp>

  network inet dgram,
  network inet stream,
  network inet6 dgram,
  network inet6 stream,
  network netlink raw,

  signal send peer=gitstatusd,
  signal send peer=git,

  ptrace read peer=git,
  ptrace read peer=child-pager,

  @{shells_path} mrix,

  # Give glycin higher priority than `@{bin}/bwrap ix` got in the development abs
  priority=10 @{bin}/bwrap       Px -> :glycin:bwrap,

  # Well known programs used in shells, when we also have specific profiles for
  # them and want to allow them, event if they need more/different permissions
  # than what is allowed in this profile.
  @{bin}/aa-log                  Px,
  @{bin}/claude                  Px,
  @{bin}/docker                  Ux, # TODO Px,
  @{bin}/dpkg-query              Px,
  @{bin}/git                     Px,
  @{bin}/htop                    Px,
  @{bin}/ip                      Px,
  @{bin}/journalctl              Px,
  @{bin}/man                     Px,
  @{bin}/nproc                   Px,
  @{bin}/ps                      Px,
  @{bin}/ssh                     Px,
  @{bin}/top                     Px,
  @{bin}/uptime                  Px,
  @{bin}/w                       Px,
  /opt/claude-code/bin/claude    Px,

  # Handle shell prompts, out of scope, thus unconfined
  @{bin}/starship                Cx -> starship,

  # Well known shells tools
  priority=1 @{user_cache_dirs}/gitstatus/gitstatusd{,-*} Px,
  priority=1 /usr/share/zsh-theme-powerlevel{9,10}k/gitstatus/usrbin/gitstatusd{,-*} Px,

  owner @{config_dirs}/User/globalStorage/**/ r,

  owner @{user_projects_dirs}/ r,
  owner @{user_projects_dirs}/** rwkl -> @{user_projects_dirs}/**,

  owner @{user_config_dirs}/git/*config r,

  profile starship {
    include <abstractions/base>
    include <abstractions/consoles>
    include <abstractions/nameservice-strict>

    @{bin}/starship mr,

    owner @{user_cache_dirs}/starship/ rw,
    owner @{user_cache_dirs}/starship/** rw,
    owner @{user_config_dirs}/starship.toml r,

    owner @{user_projects_dirs}/**/.git/{,**} r,

    @{sys}/class/power_supply/ r,

    owner @{PROC}/@{pid}/cgroup r,

    include if exists <local/code-shells_starship>
  }

  include if exists <local/code-shells>
}

# vim:syntax=apparmor
